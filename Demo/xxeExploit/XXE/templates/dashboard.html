{% extends "base.html" %}

{% block content %}
<h1>Validation Dashboard</h1>

<!-- Section to toggle RESOLVE_ENTITIES -->
<div style="margin-bottom: 20px;">
    <!-- <h2>Entity Resolution Setting</h2> -->
    <!-- <p>Current Value: 
        <strong id="resolve-entities-status">
            {% if resolve_entities %}Enabled{% else %}Disabled{% endif %}
        </strong>
    </p> -->
    <button id="toggle-resolve-entities" style="display:none; padding: 5px 10px;">
        Toggle Entity Resolution
    </button>
</div>

<div style="margin-bottom: 20px;">
        <center>
            <span class="kill-switch-title">Entity Resolution Kill Switch</span>
    {% comment %} <button id="enable-resolve-entities" style="padding: 5px 10px; background-color: #4CAF50; color: white; border: none; border-radius: 4px;">
        Enable Entity Resolution
    </button>
    <button id="disable-resolve-entities" style="padding: 5px 10px; background-color: #f44336; color: white; border: none; border-radius: 4px;">
        Disable Entity Resolution
    </button> {% endcomment %}
    <label class="switch">
        <input type="checkbox" id="resolve-entities-toggle" {% if resolve_entities %}checked{% endif %}>
        <span class="slider round"></span>
    </label>
    </center>
</div>
<script>
    document.getElementById("resolve-entities-toggle").addEventListener("change", function () {
        const isEnabled = this.checked; // Check if the toggle is enabled
        fetch("{% url 'update_resolve_entities' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: `resolve_entities=${isEnabled}` // Send the toggle state to the server
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Entity Resolution has been ${isEnabled ? "enabled" : "disabled"}.`);
            } else {
                alert("Failed to update Entity Resolution setting.");
                // Revert the toggle state if the API call fails
                this.checked = !isEnabled;
            }
        })
        .catch(error => {
            console.error("Error updating Entity Resolution:", error);
            alert("An error occurred while updating the setting.");
            // Revert the toggle state if an error occurs
            this.checked = !isEnabled;
        });
    });
</script>

<style>
    .kill-switch-title {
        font-family: 'Comic Sans Ms', sans-serif; /* Change the font */
        font-size: 25px; /* Change the size */
        font-weight: bold; /* Make it bold */
        color:rgb(184, 28, 241); /* Change the color */
        margin-bottom: 10px; /* Add some spacing */
        display: block; /* Ensure it appears above the toggle */
    }
    .switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
    }

    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 34px;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
    }

    input:checked + .slider {
        background-color: #4CAF50;
    }

    input:checked + .slider:before {
        transform: translateX(26px);
    }
</style>

<!-- Heading for adding a new RegexRule -->
<h2>Add New Rule</h2>

<!-- Form for adding a new RegexRule -->
<form method="post" action="{% url 'Save Validation' %}" style="margin-bottom: 20px;">
    {% csrf_token %}
    <div style="display: flex; gap: 10px; align-items: center;">
        <input type="text" id="name" name="name" placeholder="Enter name" required style="flex: 1;">
        <input type="text" id="regex" name="regex" placeholder="Enter regex" required style="flex: 2;">
        <div>
            <input type="radio" id="is_allowed_true" name="is_allowed" value="True" required>
            <label for="is_allowed_true">True</label>
            <input type="radio" id="is_allowed_false" name="is_allowed" value="False" required>
            <label for="is_allowed_false">False</label>
        </div>
        <button type="submit" style="padding: 5px 10px;">Save</button>
    </div>
</form>

<!-- Table for listing existing RegexRules -->
<table style="width: 100%; border-collapse: collapse;">
    <thead>
        <tr>
            <th style="border-bottom: 1px solid #ddd; padding: 8px;">Name</th>
            <th style="border-bottom: 1px solid #ddd; padding: 8px;">Regex</th>
            <th style="border-bottom: 1px solid #ddd; padding: 8px;">Is Allowed</th>
            <th style="border-bottom: 1px solid #ddd; padding: 8px;">Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for rule in regex_rules %}
        <tr>
            <td style="border-bottom: 1px solid #ddd; padding: 8px;">{{ rule.name }}</td>
            <td style="border-bottom: 1px solid #ddd; padding: 8px;">{{ rule.regex }}</td>
            <td style="border-bottom: 1px solid #ddd; padding: 8px;">{{ rule.is_allowed }}</td>
            <td style="border-bottom: 1px solid #ddd; padding: 8px;">
                <a href="{% url 'Edit Validation' rule.id %}" style="padding: 5px 10px; background-color: #4CAF50; color: white; text-decoration: none; border-radius: 4px;">Edit</a>
                <a href="{% url 'Delete Validation' rule.id %}" style="padding: 5px 10px; background-color: #f44336; color: white; text-decoration: none; border-radius: 4px;">Delete</a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
    document.getElementById("toggle-resolve-entities").addEventListener("click", function () {
        const currentStatus = document.getElementById("resolve-entities-status").innerText === "Enabled";
        const newStatus = currentStatus ? "false" : "true";

        fetch("{% url 'update_resolve_entities' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: `resolve_entities=${newStatus}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById("resolve-entities-status").innerText = newStatus === "true" ? "Enabled" : "Disabled";
            } else {
                alert("Failed to update setting.");
            }
        });
    });

    document.getElementById("enable-resolve-entities").addEventListener("click", function () {
        fetch("{% url 'update_resolve_entities' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: "resolve_entities=true"
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert("Entity Resolution has been enabled.");
            } else {
                alert("Failed to update setting.");
            }
        });
    });

    document.getElementById("disable-resolve-entities").addEventListener("click", function () {
        fetch("{% url 'update_resolve_entities' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: "resolve_entities=false"
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert("Entity Resolution has been disabled.");
            } else {
                alert("Failed to update setting.");
            }
        });
    });
</script>
{% endblock %}